<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.dromara.workflow.mapper.ActTaskMapper">
    <resultMap type="org.dromara.workflow.domain.vo.TaskVo" id="TaskWaitingVoResult">
        <result property="id" column="ID_"/>
        <result property="name" column="NAME_"/>
        <result property="description" column="DESCRIPTION_"/>
        <result property="priority" column="PRIORITY_"/>
        <result property="owner" column="OWNER_"/>
        <result property="assignee" column="ASSIGNEE_"/>
        <result property="processInstanceId" column="PROC_INST_ID_"/>
        <result property="executionId" column="EXECUTION_ID_"/>
        <result property="taskDefinitionId" column="TASK_DEF_ID_"/>
        <result property="processDefinitionId" column="PROC_DEF_ID_"/>
        <result property="createTime" column="CREATE_TIME_"/>
        <result property="endTime" column="END_TIME_"/>
        <result property="taskDefinitionKey" column="TASK_DEF_KEY_"/>
        <result property="dueDate" column="DUE_DATE_"/>
        <result property="processDefinitionKey" column="key_"/>
        <result property="category" column="CATEGORY_"/>
        <result property="parentTaskId" column="PARENT_TASK_ID_"/>
        <result property="tenantId" column="TENANT_ID_"/>
        <result property="claimTime" column="CLAIM_TIME"/>
        <result property="businessStatus" column="BUSINESS_STATUS_"/>
        <result property="processDefinitionName" column="processDefinitionName"/>
        <result property="processDefinitionKey" column="processDefinitionName"/>

    </resultMap>
    <select id="getTaskWaitByPage" resultMap="TaskWaitingVoResult">
        select * from (SELECT
            RES.*,AHP.business_status_ ,ARP.name_ as processDefinitionName,ARP.key_ as processDefinitionKey
        FROM
            ACT_RU_TASK RES
                inner join ACT_HI_PROCINST AHP ON RES.PROC_INST_ID_ = AHP.PROC_INST_ID_
                inner join ACT_RE_PROCDEF ARP ON ARP.ID_ = RES.PROC_DEF_ID_
        WHERE (
                    RES.ASSIGNEE_ = #{userId}
                OR (
                            RES.ASSIGNEE_ IS NULL
                            AND EXISTS (
                                SELECT
                                    LINK.ID_
                                FROM
                                    ACT_RU_IDENTITYLINK LINK
                                WHERE
                                    LINK.TASK_ID_ = RES.ID_
                                  AND LINK.TYPE_ = 'candidate'
                                  AND (
                                            LINK.USER_ID_ = #{userId}
                                            <if test="groupIds != null and groupIds.size() > 0">
                                                OR (
                                                LINK.GROUP_ID_ IN
                                                <foreach collection="groupIds" item="groupId" index="index" open="(" close=")" separator=",">
                                                    #{groupId}
                                                </foreach>
                                                )
                                            </if>

                                    )
                                )
                        )
            )
        ORDER BY
            RES.CREATE_TIME_ DESC) t
        ${ew.getCustomSqlSegment}
    </select>
</mapper>
